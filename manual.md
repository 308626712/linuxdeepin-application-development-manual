Linux Deepin 应用程序开发手册
==========================

> 王勇 于 2013年夏

* * *

*    [前言](#prelude)
    *    [致战斗在一线的 Linux Deepin 勇士们, 为理想而战！](#for-dream)
    *    [为什么我要写这本书？](#why-i-write-this-book)
    *    [本书面向的读者人群](#reader-need-to-know)
	*	 [代码实例](#example-code)
  
*    [编码之前的思考](#think-before-coding)
    *    [Linux需要什么样的应用程序？](#what-kind-of-application-is-we-need)
    *    [开发者应该怀着怎样的理念去开发用户喜欢的产品？](#development-concept)
    *    [我们需要怎样的应用开发社区氛围？](#how-to-build-development-community)
    *    [怎样一步一步构建Linux应用程序？](#build-application-step-by-step)
    *    [开发应用程序都需要掌握哪些基本技术？](#what-technology-we-need)
    *    [补丁编写的方法](#how-to-write-patch)
    *    [编写干净优雅的代码](#write-clean-code)
    *    [为什么选择 PyGTK+ 作为应用程序开发基础？](#why-choose-pygtk)
    *    [关于 Python/PyGTK+ 的错误认识](#misconceptions-about-python/pygtk)
    *    [Python代码编写规范](#python-coding-specification)
  
*    [Deepin-UI](#deepin-ui)
    *    [Deepin-UI 诞生的故事](#how-deepin-ui-born)
    *    [为什么需要 Deepin-UI?](#why-we-need-deepin-ui)
    *    [Deepin-UI 原理](#principle-of-deepin-ui)
    *    [Deepin-UI hello world!](#deepin-ui-hello-world)
    *    [Deepin-UI 简单控件使用](#usage-of-simple-widget)
    *    [Deepin-UI 高级控件使用](#usage-of-advanced-widget)
    *    [Deepin-UI 应用开发实例](#application-development-example)
	
*    [应用开发基础技术](#application-development-technology)
    *    [GTK+陷阱与技巧](#gtk-trick)
    *    [编写 Python C 扩展](#build-c-extension)
    *    [更多技术...](#more-technology)
	
*    [编写控件的艺术](#the-art-of-building-widget)
    *    [控件的重要性!](#the-importance-of-widget)
    *    [控件编写的基本原理](#the-principle-of-building-widget)
    *    [控件的构思到实现](#from-conception-to-realization)
    *    [控件编写实例](#widget-building-example)
	
* * *

<h2 id="prelude">前言</h2>

<h3 id="for-dream">致战斗在一线的 Linux Deepin 勇士们, 为理想而战！</h3>
> 在我写这本书的时候， 在中国武汉有这么一群斗士们， 他们在为中国Linux操作系统这个梦想默默的战斗着:   

>> 他们回家敲代码到半夜早已是家常便饭，他们每天都面临巨大的压力和工作量， 他们每天都面对新功能和无数Bug奋斗到深夜。  
>> 他们每天都游离于各种系统底层问题， 编译的刷屏陪他们经历了无数个日夜， 只为用户能稳定的运行系统。   
>> 他们面对操作系统级别的复杂设计时， 面对设计上各种苛刻限制， 他们永远展现的是自信和微笑。  
>> 他们细心的聆听用户的意见， 即使是最细小的用户需求都不放过。  

> 每当用户沉浸在正式版发布以后的欢喜中时， 他们早已背好行囊继续前行， 因为他们知道即使非常努力， 相对于完美仍然不够 ...  
> 在这么一个浮躁和功利的现实社会， 面对无数的误解和嘲笑时， 他们没有时间停下来打口水仗， 因为他们知道完美的产品才是最好的回击！  

> 如果有一天我们都年近古稀， 回忆起现在年轻的时候， 我们能无怨无悔的说：  
>> 我们没有浪费时间在抱怨和无奈中  
>> 我们把自己最好的青春奉献给自己最热爱的梦想  
>> 我们在尘归尘、土归土的时候还能给这个世界留下了贡献和回忆   

> 致现在仍然奋斗在一线的深度兄弟姐妹们， 为梦想加油！  

<h3 id="why-i-write-this-book">为什么我要写这本书?</h3>
> Linux 从1991年诞生到现在的20多年已经深入了我们生活的方方面面，  
从个人电脑到超级计算机， 从电视机顶盒到我们天天把玩的手机、平板，  
甚至在各种毫不起眼的地方（地铁， 公交车站， 售货机， 电子广告牌等）都在运行着Linux。  

> 全世界的黑客每天都在通过自己过人的天赋和勤奋向世界证明:  
>> 即使我们分散在世界各地， 即使我们互不认识，我们依然能通过无私和正能量建造世界上最伟大的操作系统！  

> Linux 从出生就烙下深深的技术烙印， Linux 从内核、驱动、底层基础库到各种变态工具中无不展现出超强的技术实力  
这也是Linux社区深深自豪的地方， Linux天生高效灵活的技术特质很容易就能夺取服务器、嵌入式、超算这些依赖后台技术的市场  

> 除了 Android 系统外， Linux在桌面这种直接面向用户体验的市场时却节节败退 （市场份额最有话语权）， 究其原因：  
>> Linux社区缺少技术牛人？  
>> Linux社区的合作开发有问题？  
>> Linux社区缺少能美化界面的设计师？  

> 我觉的都不是， Linux之所以在桌面上奋斗了十年不能竞争过 Microsoft 和 Apple 的最大原因是：  
>> 我们没有真的为**普通用户的需求**而思考  
>> 我们没有为了**完美的用户体验**而努力!  

> 我们总是以技术牛人自居， 我们总是狂妄地以自己的标准来代表用户，  
我们真的从世界上那些 99% 技术不如我们的人的角度去思考过问题吗？  
技术应该给世界大多数人带来更多简单的生活， 而不是只是为了做有最多牛X技术堆砌而体验极差的产品，  
Mac 早就明白 ”少即是多的设计能赢得大多数用户“ 的道理  

> 我们总是鄙视那些做UI的， 认为他们不过是换皮肤而已， 但是我们是否可知道：  
>> 一个丑陋没有经过任何排版设计的界面简直就是对用户的煎熬  
>> 一个交互体验细节极差的产品即使技术再牛X， 该难用还是难用！  

> 我们应该为了完美的用户体验不放过任何一个细节， 不放过哪怕一个像素的误差， 要做就做最好的!  
> Linux 之所有输了桌面之战， 不是因为我们没有努力，  
而是大多数高手以为我们在正确的路上战斗， 我们输在正确认识用户交互体验的理念上了。  

> 这本书的目的不光是讲解怎样从技术上实现应用程序，  
更希望能在Linux社区建立做产品的正确理念， 激励更多的开发者加入制造Linux高质量应用的行动中去。  

<h3 id="reader-need-to-know">本书面向的读者人群</h3>
> 这本书不是一本讲解怎样进行初步编程的入门书籍，  
本书主要是给有图形编程经验的编程人员提供全方位的方法来构建高质量的应用程序， 所以需要读者至少熟练下面的基本技术：
>> C语言编程  
>> Python语言编程  
>> GTK+图形编程  

> 读者朋友们可以通过系统学习以下书籍来掌握这些基本技术：
>> 《C程序设计语言》 (The C programming language)  
>> 《Python核心编程第二版》 (Core Python programming)  
>> 《GTK+开发基础》(Foundations of GTK+ development)  

<h3 id="example-code">代码实例</h3>
> 本书中所有代码都在 Linux Deepin 下进行测试， 书中所有的源代码都可以在 example 目录下找到.  

> 书中的源代码严格遵循GPL3协议， 欢迎读者们利用代码进行二次开发， 但同时请遵守GPL3协议的开放你的源代码。

<h3 id="what-kind-of-application-is-we-need">Linux需要怎么样的应用程序？</h3>
> 传统的Linux应用程序一般都是由开源技术爱好者主导， 他们一般都是在校大学生或者专业的工程师在业余时间完成的，  
> 这些人都是非常富有创造力的工程师， 他们通过自己的热情做出了很多技术上非常牛X的产品出来，  
> 在Linux刚开始发展的时候， 这些应用程序对Linux的发展起到了巨大的推动作用。  

> 但是， 大多数开源程序都会面临下面的几个问题：  
>> * 很多项目只是作者的爱好或者学习的项目， 一般做到 demo 级别就不再进步  
或者原作者毕业以后， 没有时间再维护项目继续向前发展， 很多很有潜力项目因为原作者的离去而衰落  

>> * 很多开源应用软件都只是无限制的堆砌功能， 项目的目标是我要有所有功能， 到最后越来越臃肿  

>> * 很多开源项目并没有专门的设计师来来优化软件的UE， 让复杂的功能在合理的位置展示以简化交互流程  

>> * 很多开源项目并没有专门的设计师做整体的UI控件、布局和用色进行优化， 做出的产品从UI上说只能是中规中矩  

> Linux发展到今天， 用户对一个好的应用要求非常高， 那么Linux需要做到什么样的应用才能吸引用户：  
>> * 我们应该做一个完全功能的软件能满足用户的需求， 而不是一个又一个半成品， 太多的半成品在深深伤害着用户对Linux的信心  

>> * 一个完美的应用应该面向使用场景做到恰到好处, 学会对产品做减法， 而不是功能的堆砌，  
完美的标准就是： 没有任何功能可以去掉了， 而不是还可以添加更多的功能   

>> * 我们应该为普通小白用户做产品， 而不是为Linux专家做产品，  
只有没有太多计算基础的用户能理解才能带来更多的用户， 而不是技术牛人的小众玩物  

>> * 一个完美的应用应该具有最简单的交互流程， 我们要经常问自己，  
流程能不能再简单一点， 能不能做到不用任何学习就能理解，  
而不是无穷的菜单和对话框， 经常看到很多Linux应用程序不知道怎么在合适的地方设计功能时，  
只是简单的把功能放到工具栏和菜单栏， 或者一层又一层的对话框， 菜单和对话框都是转移用户焦点的设计，  
太多只会导致用户的交互流程不能顺畅的运行， 最终也会增加应用整体使用的复杂性。  

>> * Linux应用应该具有并超越 Windows 和 Mac 的美观度才能对普通用户有一见倾心的吸引力，  
UI的美观和细致永远都是高质量应用应该具备的基本条件。  

<h3 id="development-concept">开发者应该怀着怎样的理念去开发用户喜欢的产品？</h3>
> Linux社区的一大特色就作者不但是构建者， 同时也是最终用户，  
在很多专业领域， 特别是编程领域， 这样的产品开发思维能开发出非常伟大的产品， 比如 emacs/vi, blender, gimp 等。

> Linux社区从来不缺乏专业性的好用工具， 但是在缺乏太多太多对普通用户足够易用的应用，  
> 究其原因还是Linux社区内缺乏足够有能力为普通用户开发产品的应用开发者。  

> 那么应用程序开发者应该怀着怎样的理念去开发用户喜欢的产品呢？
>> 1. 开发者本人应该是一个非常热爱生活的人， 善于和普通人沟通的人，  
只有我们真正了解了产品背后的人性心理并深入了解用户的需求后才能做出好用的产品。   
在现代这个资讯消费的时代， 简单的人性分析就是， 用户都是：
>>> * 懒惰的， 如果能动一下手指就能完成的任务， 用户绝对不愿意动第二下。
>>> * 没有耐心的： 如果你的产品不能让用户在第一分钟内喜欢上， 用户很难再次使用你的产品。
>>> * 不爱学习的： 他们更希望能在马桶上的时间就能学到东西， 他们不愿花几个月去思考Linux背后的原理。
>>> * 爽比功能更重要： 优秀的应用和普通应用的区别就是， 你的产品用着就是爽！

>> 2. 开发者要认同， 一个易用的产品不但需要有强大技术基础，  
还要有优秀的设计和体验细节， 光是技术做出的产品都太逻辑化了， 没有感染用户的生命力。  

>> 3. 开发者要时刻提醒自己： 到底谁才是我们的目标用户？  
做到这一点很难， 很多开发者都是以自我来代表用户的需求了  

>> 4. 开发者要有底线： 不是每一个用户的需求都要添加的，  
开发者要懂的：  
>>> * 我们的产品是面向应用场景而做的， 而不是要做一个全功能的产品。  
>>> * 真正吸引用户的是满足应用场景的核心功能， 而不是不重要的功能和重要功能都堆砌在界面中。  
>>> * 要学会把核心功能放在显眼的位置， 非核心功能放在不显眼的角落， 砍掉看似有用但是用户不会用的功能。  
>>> * 我们的产品应该是恰大好处的自信， 无限制的加功能源于不自信， 止步于臃肿没落。  

>> 5. 开发者要有一颗坚强的心和抗吐槽的能力，  
用户批评你那是喜欢你的程序， 如果你开发的应用他用都不想用， 他更加懒得吐槽你  

<h3 id="how-to-build-development-community">我们需要怎样的应用开发社区氛围？</h3>
> Linux和任何其他软件开发模式最大的不同就是它的开放性， 开发者之间可以非常方便的进行技术交流，  
开发者和用户之间通过社区会有大量的交流， 让用户在产品初期就可以介入讨论。  
这种开放式的开发模式， 不但能极大提高开发者效率， 也能通过和用户之间的交流进行快速的产品缺陷更正。  

> 一个良好的开发社区氛围能极大的促进产品的发展， 而建立一个良好的开发社区氛围关键点在于：
>> * 开放
>> * 包容
>> * 实干

> 那么一个良好的开发社区应该具有具体怎么做才能形成正能量呢？
>> 1. 开发者和用户要有良好的沟通， 开发者在保证功能稳定的前提下应提前发布一些预览版让用户尝鲜，  
很多设计之初没有考虑到的问题在这个阶段能够充分的暴露出来， 以供后续版本改进。  

>> 2. 开发者之间要相互合作， 互相学习对方的优势技术做出自己产品的特色来，  
千万不要像很多Linux开源社区， 都认为自己是最好的， 其他的都是垃圾，  
这个世界上没有最好的产品， 只有最适合用户的产品。  

>> 3. 用户要对开发者要有足够的耐心， 不要一味的吐槽狂喷，  
开源软件一般都是免费使用的， 一个软件投入了作者和制作团队巨大的艰辛和努力，  
作为产品使用的伸手党我们该对开发者有更多的包容心， 即使他们当前做的不好，  
只要他们充满一腔热情在演进产品， 我们就应该多多鼓励他们， 而不是各种神吐槽，   
Fcitx原作者放弃开发这种悲剧不要再重演。  

>> 4. 开发者也要从用户的角度考虑问题， 不要什么都是技术至上,  
很多Linux开发者有一股非常强势的技术优先思路， 超强的技术是基础， 但不是全部  
做应用软件能否做的好用的最关键点在于开发者是否能够深入到用户的需求中，完善每一个交互细节。   
简单易用的用户体验不一定需要软件的核心原创性多强， 即使原理和其他同类软件都是一样的  
但是你的产品中的每一个细节（UI细致， 控件细节， 交互细节等）都做的很好， 最终照样可以做出完美体验的产品。  
中国大陆的 QQ 聊天工具就是一个最好的例子， 他的原理并不是什么颠覆性的， 但是他的每一个细节都是精雕细作打磨而来的。  

>> 5. Talk is cheap, show me the product!  
如果 Linus 的 "Talk is cheap, show me the code!" 强调内核开发社区的理念  
"Talk is cheap, show me the product!" 就应该是应用产品的开发氛围  
Linux各大社区都充满了太多太多的讨论， 讨论越多越好， 但是太多的讨论仅仅只是吐槽， 而没有实际动作  
Linux桌面以及应用要快速的成长需要的是有一批实干精神的开发者和爱好者实际行动起来解决各种问题  
如果你知道问题在什么地方而且有能力解决， 马上去做， 而不只是耍一下嘴皮子!  
实干才能劈斩荆棘， 实干才能改变世界！   

<h3 id="build-application-step-by-step">怎样一步一步的构建Linux应用程序</h3>
这是很多大学生会问的第一个问题， 我有热情， 我有技术， 到底怎样才能构建用户喜欢的Linux应用程序呢？  

> 1. 问一下自己， 用户为什么要选择你做的产品？  
>> 我们做产品之前， 一定要清楚的知道， 我们的产品到底有什么优势， 是否能比其他产品更好的解决用户面临的问题？  
>> 只有我们对自己的产品的定位有一个清晰的认识， 我们才能在后面做产品的过程中遇到的问题进行理性的决断。

> 2. 对产品的交互流程进行详细的规划.  
>> 一旦定下产品的目标以后， 就要在交互的流程进行规划， 一个清晰的交互流程规划能极大的简化日后的编码和设计工作, 比如：  
>>> * 什么控件放在什么地方比较符合用户的期望
>>> * 第一步要完成什么， 第二步要完成什么, 每一个界面要表达的交互理念是什么？
>>> * 整个交互流程是否足够简单, 整体的交互逻辑是否还有漏洞和不完备的地方
>>> * 等等

> 3. 编码前通过草图进行框架思考.
>> 定下目标和交互流程后， 就要考虑怎样用代码来实现我们的需求了， 很多同学犯了一个大忌，  
>> 一旦知道我们需要什么后， 不管三七二十一马上就开始编码,  
>> 如果没有事先思考就进入编码会在项目后期因为考虑不周而导致非常严重的返工。  
>>   
>> 我给Linux Deepin的同学要求到:  
>> 如果你的代码框架不能在纸上画清楚的话就证明你依然对某些实现细节的思考不够清晰，  
>> 软件工程和建筑设计很像， 如果对某一块没有事先规划好或者没有想清楚，  
>> 这一块不清晰的地方以后就会成为阻挡项目向前推进的重大阻碍。  
>> 这个阶段应该思考的是：  
>>> * 怎样设计一个技术框架流程才能最大程度减少重复编码和重复模块出现?  
>>> * 评估整个流程中每一个子模块的功能要用什么样的技术去实现?  
>>> * 每个子模块实现的依赖关系和先后顺序， 哪些要先实现， 哪些要后实现， 哪些需要完成其他模块后才能实现？  

> 4. 分解问题， 验证原型可行性：
>> 所有需求和技术框架完成后， 我们就需要对所有的技术问题进行分解。  
>> 分解的要求就是把问题分解到能在很短时间实现的小模块， 然后通过编码依次实现这些小模块进行可行性验证。  
>> 如果有些模块当前技术无法实现， 是否需要修改原先的设计需求？  

> 5. 组合解决方案， 整体化框架实现。
>> 完成任务分解验证代码后， 就要考虑整体化组合编码。  
>> 在这个过程主要注意的问题是:  
>>> * 对每个模块编写测试用例, 这样能提高测试效率， 并快速定位哪一个模块出错。  
>>> * 怎样让每一个模块的输入/输出可以有效的串联起来组成最后的产品。  
>>> * 每个子模块之间的相互关系是否足够简单， 是否具有扩展性和维护性？  
>>> * 注意实际应用场景中的体验式修改， 比如有些耗时的操作需要添加多线程来改进UI上很卡的问题？  

> 6. 测试， 优化。
>> 整体功能流程测试， 这个阶段可以测试出单个模块测试不出的问题。  
>> UI 测试， 看看控件是否对齐， 字体、颜色等是否看着舒服。  
>> 基于数据结果的优化， 运行一些测试程序， 测试出程序的内存和性能瓶颈， 针对性优化。
>> 不要做提前优化和基于猜测的优化。

<h3 id="what-technology-we-need">开发应用程序都需要掌握哪些基本技术？</h3>
> 前面我们已经知道了构建应用程序的基本步骤， 那么哪些基础技术是开发应用程序所需要的呢？
>> * 基本的数学知识: 平面和立体几何学、线性代数、 三角函数、集合、统计概率等基础数学知识。  
>> * 多种编程语言的编程实践锻炼： C 和 Python 是最基础的， 更多的编程语言能极大扩展自己对计算机的理解和自己的编程视野。  
>> * 熟悉动画和游戏的制作原理， 精通游戏的原理和制作能极大提升应用程序基础开发能力和想象力。
>> * 熟悉 GTK+或者QT 90% 以上的API的作用和用法： 本书主要介绍 GTK+ 和 Deepin-UI 。  
>> * 要非常清楚的知道进程和线程的区别和在实际项目中应用场景。  
>> * 给自己配一把好的编程武器， vi 和 emacs 是Linux编程界的两大利器， 熟练掌握它们中的其中一个都可以大大提升编程效率。  
>> * 平常多玩关于多媒体相关的底层库, 比如: Cairo, Pango, GIO, WebKit, Poppler, VTE, GStreamer, Curl 等  
>> * 最后一点： 热爱生活， 多观察生活中事物并融合到自己产品的交互中。

> 好吧， 这几乎是 Linux Deepin 对桌面开发工程师的基本要求了。 ;)

<h2 id="deepin-ui">Deepin-UI</h2>

<h3 id="how-deepin-ui-born">Deepin-UI诞生的故事</h3>

